<html>
  <body>

    <script src="threeJS/build/three.min.js"></script>
    <script type="text/javascript" src="perlin.js"></script>

      <script id="vertexShader" type="x-shader/x-vertex">
            
        #define PI 3.14159

        precision mediump float;
        precision mediump int;
            
        uniform mat4 modelViewMatrix; // optional
        uniform mat4 projectionMatrix; // optional
            
        attribute vec3 position;
        attribute vec4 color;
        attribute vec3 normal;
            
        varying vec3 vPosition;
        varying vec4 vColor;
        
        void main() {
          
          vPosition = position*1.0;
          vColor = color;
          gl_Position = projectionMatrix * modelViewMatrix * vec4 (vPosition, 1.0);
        }

        </script>
        
        <script id="fragmentShader" type="x-shader/x-fragment">
            
          precision mediump float;
          precision mediump int;
            
          uniform float time;  
          varying vec3 vPosition;
          varying vec4 vColor;
          varying vec2 quad;
            
          void main() {
            float x = vPosition.x;
            gl_FragColor = vColor; 
          }
        </script>
        
    <script>
            
      var cnt = 0;
      var N = 1000;
      var frameCnt = 0;
      var fx = 0.001;
      var fz = 0.001;

      var positions = new Float32Array (N*N*18);
      var colors    = new Float32Array (N*N*18);
      var normal    = new Float32Array (N*N*18);
      

      var addQuad = function (positions, x, z, w) {

        var A = 200;
        var h = noise.simplex3(x*fx,z*fz,0)*A;
        // 0, 0
        positions [cnt*6*3+0] = x;
        positions [cnt*6*3+1] = h;
        positions [cnt*6*3+2] = z;
               
        // w, 0     
        x0 = x+w;
        z0 = z;
        h = noise.simplex3(x0*fx,z0*fz,0)*A;
        positions [cnt*6*3+3] = x0;
        positions [cnt*6*3+4] = h;
        positions [cnt*6*3+5] = z0;
                    
        // w, w
        z0 = z+w;
        h = noise.simplex3(x0*fx,z0*fz,0)*A;
        positions [cnt*6*3+6] = x0;
        positions [cnt*6*3+7] = h;
        positions [cnt*6*3+8] = z0;



        //
        x0 = x;
        z0 = z;
        h = noise.simplex3(x0*fx,z0*fz,0)*A;
        positions [cnt*6*3+9] = x0;
        positions [cnt*6*3+10] = h;
        positions [cnt*6*3+11] = z0;
        

        // w, 0     
        z0 = z+w;
        h = noise.simplex3(x0*fx,z0*fz,0)*A;
        positions [cnt*6*3+12] = x0;
        positions [cnt*6*3+13] = h;
        positions [cnt*6*3+14] = z0;
                    
        // w, w
        x0 = x+w;
        h = noise.simplex3(x0*fx,z0*fz,0)*A;
        positions [cnt*6*3+15] = x0;
        positions [cnt*6*3+16] = h;
        positions [cnt*6*3+17] = z0;

        
        colors[cnt*18] = 1.0;
        colors[cnt*18+1] = 1.0;
        colors[cnt*18+2] = 1.0;

        colors[cnt*18+3] = 1.0;
        colors[cnt*18+4] = 0.0;
        colors[cnt*18+5] = 1.0;    

        colors[cnt*18+6] = 1.0;
        colors[cnt*18+7] = 0.0;
        colors[cnt*18+8] = 1.0;

        colors[cnt*18+9] = 1.0;
        colors[cnt*18+10] = 0.0;
        colors[cnt*18+11] = 1.0;     

        colors[cnt*18+12] = 1.0;
        colors[cnt*18+13] = 0.0;
        colors[cnt*18+14] = 1.0;     

        colors[cnt*18+15] = 1.0;
        colors[cnt*18+16] = 0.0;
        colors[cnt*18+17] = 1.0;     

        cnt += 1;
      }


      var clear = function() {

      }

      var addQuads = function () {
        cnt = 0;

        for (var i=0; i<N; i++) {
          for (var j=0; j<N; j++) {
            x = (i-N/2)*20;
            z = (j-N/2)*20;
            addQuad (positions, x, z, 15);
          } 
        }  
      }


      var createElements = function (x, y, z, id) {
                
        var material = new THREE.MeshBasicMaterial({color: 0xa00aff});
        var shader = new THREE.RawShaderMaterial ({
                            uniforms: {
                              time: { type: "f", value: 1.0 }
                            },
                            vertexShader: document.getElementById ('vertexShader').textContent,
                            fragmentShader: document.getElementById ('fragmentShader').textContent,
                            side: THREE.DoubleSide,
                            transparent: true
                        });
        var geometry = new THREE.BufferGeometry();
        
        /*
        for (var i=0; i<N*18; i++) {
          colors[i] = 1.0;
        }
        */
        addQuads();     
        geometry.addAttribute ("position", new THREE.BufferAttribute (positions, 3));
        geometry.addAttribute ("color",    new THREE.BufferAttribute (colors, 3));
        geometry.addAttribute ("normal",   new THREE.BufferAttribute (normal, 3));
                
        //var material = new THREE.MeshBasicMaterial({ vertexColors: THREE.VertexColors });        
        var material = new THREE.RawShaderMaterial( {
          uniforms: {
            time: { type: "f", value: 1.0 }
          },

          vertexShader: document.getElementById ('vertexShader').textContent,
          fragmentShader: document.getElementById ('fragmentShader').textContent,
          side: THREE.DoubleSide,
          transparent: true
        });
                                                           
        var mesh = new THREE.Mesh (geometry, material);
        return mesh;
      }

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera (75, window.innerWidth/window.innerHeight, 0.1, 10000);

      var renderer = new THREE.WebGLRenderer();
      renderer.setSize (window.innerWidth, window.innerHeight);
      document.body.appendChild (renderer.domElement);
      
      var mesh = createElements();
      scene.add(mesh);




      var render = function () {
        var time = performance.now();
        
        camera.position.x = 50+0*Math.sin(time*0.0012)*1000;
        camera.position.y = 100; //Math.cos(time*0.001)*1000;
        camera.position.z = 40; //1000+Math.sin(time*0.0005)*600;
        //camera.lookAt (new THREE.Vector3 (Math.sin(time*0.001)*100000,Math.cos(time*0.0001)*100000,0));
        //camera.up = new THREE.Vector3 (0,0,1);
        
        frameCnt += 1;
        
        mesh.material.uniforms.time.value = time;

        requestAnimationFrame (render);
        renderer.render (scene, camera);
      };

      render();
    </script>
  </body>
</html>
